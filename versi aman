-- Services
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local PathfindingService = game:GetService("PathfindingService")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local hrp = character:WaitForChild("HumanoidRootPart")
local humanoid = character:WaitForChild("Humanoid")

player.CharacterAdded:Connect(function(c)
	character = c
	hrp = character:WaitForChild("HumanoidRootPart")
	humanoid = character:WaitForChild("Humanoid")
end)

-- Anti Death & Anti Kick (tidak ragdoll, selalu berdiri)
local function applyAntiDeath(state)
	if humanoid then
		for _, s in pairs({
			Enum.HumanoidStateType.FallingDown,
			Enum.HumanoidStateType.Ragdoll,
			Enum.HumanoidStateType.PlatformStanding,
			Enum.HumanoidStateType.Seated
		}) do
			humanoid:SetStateEnabled(s, not not state)
		end
		if state then
			humanoid.Health = humanoid.MaxHealth
			humanoid:GetPropertyChangedSignal("Health"):Connect(function()
				if humanoid.Health <= 0 then
					humanoid.Health = humanoid.MaxHealth
				end
			end)
		end
	end
end

-- Fungsi untuk mendapatkan posisi base
local function getBasePosition()
	local plots = workspace:FindFirstChild("Plots")
	if not plots then return nil end
	for _, plot in ipairs(plots:GetChildren()) do
		local sign = plot:FindFirstChild("PlotSign")
		local base = plot:FindFirstChild("DeliveryHitbox")
		if sign and sign:FindFirstChild("YourBase") and sign.YourBase.Enabled and base then
			return base.Position
		end
	end
	return nil
end

local Y_OFFSET = 7 -- tinggi offset agar karakter berada di atas
local STOP_DISTANCE = 5 -- jarak toleransi untuk berhenti

local currentTween
local function tweenWalkTo(position)
	if currentTween then currentTween:Cancel() end
	local startPos = hrp.Position
	local targetPos = Vector3.new(position.X, position.Y + Y_OFFSET, position.Z)
	local distance = (targetPos - startPos).Magnitude
	local speed = humanoid.WalkSpeed > 30 and humanoid.WalkSpeed or 500 -- fallback speed
	local duration = distance / speed
	local tweenInfo = TweenInfo.new(duration, Enum.EasingStyle.Linear)

	currentTween = TweenService:Create(hrp, tweenInfo, {CFrame = CFrame.new(targetPos)})
	currentTween:Play()

	humanoid:ChangeState(Enum.HumanoidStateType.Running)

	currentTween.Completed:Wait()
end

local active = false
local walkThread

local function isAtBase(basePos)
	if not basePos then return false end
	local dist = (hrp.Position - basePos).Magnitude
	return dist <= STOP_DISTANCE
end

local function walkToBase()
	while active do
		local target = getBasePosition()
		if not target then
			warn("Base Not Found")
			break
		end

		-- Jika sudah dekat base, stop otomatis
		if isAtBase(target) then
			warn("Reached Base, stopping tween.")
			stopTweenToBase()
			break
		end

		local path = PathfindingService:CreatePath()
		path:ComputeAsync(hrp.Position, target)

		if path.Status == Enum.PathStatus.Success then
			for _, wp in ipairs(path:GetWaypoints()) do
				if not active then return end
				-- Cek dekat base setiap waypoint
				if isAtBase(target) then
					warn("Reached Base during path, stopping tween.")
					stopTweenToBase()
					return
				end
				tweenWalkTo(wp.Position)
			end
		else
			tweenWalkTo(target)
		end

		task.wait(1.5)
	end
end

function startTweenToBase()
	if active then return end
	active = true
	applyAntiDeath(true)
	humanoid.WalkSpeed = 16
	walkThread = task.spawn(function()
		while active do
			walkToBase()
			task.wait(1)
		end
	end)
	statusLabel.Text = "By Walvy"
	tweenButton.Text = " Tween To Base"
	tweenButton.BackgroundColor3 = Color3.fromRGB(180, 60, 60)
end

function stopTweenToBase()
	if not active then return end
	active = false
	if currentTween then currentTween:Cancel() end
	if walkThread then task.cancel(walkThread) end
	humanoid.WalkSpeed = 100
	statusLabel.Text = "By Walvy"
	tweenButton.Text = "Tween To Base"
	tweenButton.BackgroundColor3 = Color3.fromRGB(40, 0, 0)
end

-- GUI Code (tidak berubah)
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "WalvyCommunityGui"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = player:WaitForChild("PlayerGui")

local mainFrame = Instance.new("Frame", ScreenGui)
mainFrame.Size = UDim2.new(0, 300, 0, 150)
mainFrame.Position = UDim2.new(0.5, -150, 0.5, -75)
mainFrame.BackgroundColor3 = Color3.fromRGB(25, 0, 0)
mainFrame.BorderSizePixel = 0
mainFrame.AnchorPoint = Vector2.new(0.5, 0.5)
Instance.new("UICorner", mainFrame).CornerRadius = UDim.new(0, 15)

local titleLabel = Instance.new("TextLabel", mainFrame)
titleLabel.Text = "WALVY COMMUNITY"
titleLabel.Size = UDim2.new(1, 0, 0, 25)
titleLabel.Position = UDim2.new(0, 0, 0, 5)
titleLabel.BackgroundTransparency = 1
titleLabel.TextColor3 = Color3.fromRGB(255, 50, 50)
titleLabel.Font = Enum.Font.GothamBold
titleLabel.TextSize = 18

statusLabel = Instance.new("TextLabel", mainFrame)
statusLabel.Text = "By Walvy"
statusLabel.Size = UDim2.new(1, -20, 0, 30)
statusLabel.Position = UDim2.new(0, 10, 0, 100)
statusLabel.BackgroundTransparency = 1
statusLabel.TextColor3 = Color3.fromRGB(255, 180, 180)
statusLabel.Font = Enum.Font.Gotham
statusLabel.TextSize = 14
statusLabel.TextXAlignment = Enum.TextXAlignment.Left

tweenButton = Instance.new("TextButton", mainFrame)
tweenButton.Text = "Tween To Base"
tweenButton.Size = UDim2.new(0.8, 0, 0, 45)
tweenButton.Position = UDim2.new(0.1, 0, 0, 50)
tweenButton.BackgroundColor3 = Color3.fromRGB(40, 0, 0)
tweenButton.TextColor3 = Color3.fromRGB(255, 180, 180)
tweenButton.Font = Enum.Font.GothamBold
tweenButton.TextSize = 16
Instance.new("UICorner", tweenButton).CornerRadius = UDim.new(0, 10)

-- Dragging GUI logic
local dragging, dragInput, dragStart, startPos
mainFrame.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
		dragging = true
		dragStart = input.Position
		startPos = mainFrame.Position
		input.Changed:Connect(function()
			if input.UserInputState == Enum.UserInputState.End then dragging = false end
		end)
	end
end)
mainFrame.InputChanged:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
		dragInput = input
	end
end)
UserInputService.InputChanged:Connect(function(input)
	if dragging and input == dragInput then
		local delta = input.Position - dragStart
		mainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
	end
end)

-- Button toggle
tweenButton.MouseButton1Click:Connect(function()
	if active then
		stopTweenToBase()
	else
		startTweenToBase()
	end
end)
